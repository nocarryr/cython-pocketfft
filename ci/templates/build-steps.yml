parameters:
  python.version: ''
  use_cython: 'false'
  test_mode: ''

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '$(python.version)'
  displayName: 'Use Python $(python.version)'

- script: python -m pip install -U pip setuptools wheel && pip install -r requirements.txt
  displayName: 'Install dependencies'

- ${{ if eq(parameters.use_cython, 'true') }}:
  - script: python setup.py build_ext --inplace --use-cython
    displayName: 'Build Extenstions'

  - script: python setup.py sdist bdist_wheel
    displayName: 'Build dist'

  - publish: $(System.DefaultWorkingDirectory)/dist
    artifact: $(artifact_name)

- ${{ if and(eq(parameters.use_cython, 'false'), ne(parameters.test_mode, 'wheel')) }}:
  - task: DownloadPipelineArtifact@2
    inputs:
      artifact: $(artifact_name)
      targetPath: $(System.DefaultWorkingDirectory)/dist

- ${{ if eq(parameters.test_mode, 'develop') }}:
  - script: pip install -e .
    displayName: 'Install develop mode'

- ${{ if eq(parameters.test_mode, 'wheel') }}:
  - task: DownloadPipelineArtifact@2
    inputs:
      targetPath: $(System.DefaultWorkingDirectory)/dist-temp
  - script: |
      mkdir -p $(System.DefaultWorkingDirectory)/dist
      cp -u $(System.DefaultWorkingDirectory)/dist-temp/**/* $(System.DefaultWorkingDirectory)/dist/
  - script: pip install --only-binary $(project_name) --no-index --find-links dist/ $(project_name)
    displayName: 'Install wheel'

- ${{ if eq(parameters.test_mode, 'sdist') }}:
  - script: pip install --no-binary $(project_name) --no-index --find-links dist/ $(project_name)
    displayName: 'Install sdist'

- script: python build_tests.py
  displayName: 'Build Tests'

- script: py.test
  displayName: 'Run Tests'
